<html>
<head> 	
	<title>ì£¼ë¬¸ ì •ë³´</title>
	<link href="/BookMarket/css/bootstrap.min.css" rel="stylesheet" >
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>
<body>
<div class="container py-4">
    <th:block th:replace="~{/module/header}"></th:block>


	<div class="p-5 mb-4 bg-body-tertiary rounded-3">
 		<div class="container-fluid py-5">
			<h1 class="display-5 fw-bold">ì£¼ë¬¸ ì •ë³´ </h1>
			<p class="col-md-8 fs-4">BookMarket</p>       
		</div>
		
	</div>	
   <div class="row align-items-md-stretch"> 
    <form th:object="${order}" action="/BookMarket/order/orderConfirmation" method="post" class="form-horizontal">
        <div class="container  col-md-10  py-5" style="background:#fafafe">
       <div class="text-center">
          	<h1>ì˜ìˆ˜ì¦</h1>
       </div>   
       <div class="row  text-left">
       	    <div class="col-md-6  py-3" >
           
             <strong>ë°°ì†¡ ì£¼ì†Œ</strong><br> 
              ì„±ëª… :  [[${order.shipping.name}]]<br>
            ìš°í¸ë²ˆí˜¸ :  [[${order.shipping.address.zipcode}]]<br>
            ì£¼ì†Œ :  [[${order.shipping.address.addressname}]]  [[${order.shipping.address.detailname}]]  ([[${order.shipping.address.country}]])<br>
           
          </div>
           <div class="col-md-6 text-right py-3">
             <p> <em>ë°°ì†¡ì¼: [[${order.shipping.date}]]</em></p>
          </div>
      
       </div>
      <div class="row text-left">
          <div class="col-md-6 py-2">            
                 <address> 
              <strong>ì²­êµ¬ì£¼ì†Œ</strong> <br>
               ì„±ëª… : [[${order.customer.name}]]<br>
               ìš°í¸ë²ˆí˜¸ :[[${order.customer.address.zipcode}]]<br>
               ì£¼ì†Œ : [[${order.customer.address.addressname}]] [[${order.customer.address.detailname}]] ([[${order.customer.address.country}]])<br>
                  HP : [[${order.customer.phone}]]<br>
             </address>       
          </div>
       </div>  
      
           <div class="row  py-2">
              <table class="table table-hover">
                 <thead>
                   <tr><th>ë„ì„œ</th>
                      <th>ìˆ˜ëŸ‰</th>
                      <th class="text-center">ê°€ê²©</th>
                       <th class="text-center">ì†Œê³„</th>
                    </tr>
                 </thead>
                 <tbody>

                    <div class="col-md-4" th:each="cartItem:${order.orderItems}">

                        <tr>

                             <td >
                                 <em th:each="book:${bookList}" th:if="${book != null and cartItem != null and
                                 #strings.equals(book.bookId, cartItem.value.bookId)}">[[${book.name}]]</em>

                             </td>

                             <td  style="text-align: center">[[${cartItem.value.quantity}]]</td>
                             <td class="text-center" >
                                  <span th:each="book:${bookList}"  th:if="${#strings.equals(book.bookId, cartItem.value.bookId)}">[[${book.unitPrice}]]ì›</span>
                             </td>

                             <td class="text-center">[[${cartItem.value.totalPrice}]]ì›</td>
                        </tr>
                    </div>


                        <tr>
                         <td>Â </td>
                         <td>Â </td>
                         <td class="text-right"><h5> <strong>ì´ì•¡:Â </strong></h5></td>
                         <td class="text-center text-danger"><h4><strong>[[${order.grandTotal}]]</strong></h4></td>
                        </tr>
                 </tbody>
              </table>
           </div>
       
            <div class="container col-md-5  py-3">

                <a href="/BookMarket/order/orderShippingInfo"  class=" btn btn-Secondary" role="button" >ì´ì „</a>
                <input type="submit" class="btn btn-success" value="ì£¼ë¬¸ì™„ë£Œ" />

                <div th:if="${payment != null}">
                    <input type="hidden" id="merchantUid" th:value="${payment.merchantUid}">
                    <input type="hidden" id="amount" th:value="${payment.amount}">

                    <input type="hidden" id="orderName" th:value="${order.orderName}">
                    <input type="hidden" id="customerName" th:value="${order.customer.name}">
                    <input type="hidden" id="customerEmail" th:value="${order.customer.mail}">
                    <input type="hidden" id="customerPhone" th:value="${order.customer.phone}">
                    <button id="btnPay" type="button">ê²°ì œí•˜ê¸°(<span th:text="${order.grandTotal}"></span>ì›)
                    </button>
                </div>


                <a href="/BookMarket/order/orderCancelled"  class="btn btn-Secondary" role="button" >ì·¨ì†Œ</a>
            </div>
    </form>
    </div>
    <th:block th:replace="~{/module/footer}"></th:block>
   </div>

</body>

<script th:inline="javascript">
document.addEventListener("DOMContentLoaded", function() {
    const btn = document.getElementById("btnPay");
    if (btn) {
        // ğŸ’¡ [ìˆ˜ì •] IMP.initì€ í•œ ë²ˆë§Œ í˜¸ì¶œí•˜ë©´ ë©ë‹ˆë‹¤.
        // í˜„ì¬ ì½”ë“œì— 2ê°œ ìˆì—ˆìœ¼ë¯€ë¡œ, í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.
        // ê°€ë§¹ì  ì‹ë³„ì½”ë“œë¥¼ ì„œë²„ ë³€ìˆ˜ë¡œ ë„˜ê¸°ëŠ” ê²ƒì´ ë” ì•ˆì „í•©ë‹ˆë‹¤.
        IMP.init("imp66276214");

        btn.addEventListener("click", function() {
            const merchantUid = document.getElementById("merchantUid").value;
            const amount = document.getElementById("amount").value;
            const customerName = document.getElementById("customerName").value;
            const customerEmail = document.getElementById("customerEmail").value;
            const customerPhone = document.getElementById("customerPhone").value;
            const orderName = document.getElementById("orderName").value;

            if (!merchantUid || !amount) {
                alert("ê²°ì œ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
                return;
            }

            IMP.request_pay({
                pg: "kakaopay", // PGì‚¬ ì„ íƒ
                pay_method: "card", // ê²°ì œ ìˆ˜ë‹¨
                merchant_uid: merchantUid,
                name: orderName,
                amount: amount,
                buyer_name: customerName,
                buyer_email: customerEmail,
                buyer_tel: customerPhone
            }, function(rsp) {
                if (rsp.success) {
                    // 1. í´ë¼ì´ì–¸íŠ¸ ê²€ì¦ ë° ê²°ì œ í™•ì •ì„ ìœ„í•´ ì„œë²„ì— ìš”ì²­ (JSON í˜•ì‹)
                    fetch('/payments/webhook', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json' // ğŸ’¡ [ìˆ˜ì •] JSON í˜•ì‹ìœ¼ë¡œ í†µì¼
                        },
                        body: JSON.stringify({
                            merchantUid: rsp.merchant_uid,
                            transactionId: rsp.imp_uid, // PGì‚¬ ê±°ë˜ ê³ ìœ  ë²ˆí˜¸
                            paidAmount: rsp.paid_amount
                        })
                    })
                    .then(response => {
                        // ì„œë²„ì˜ ì‘ë‹µ ìƒíƒœ ì½”ë“œë¥¼ í™•ì¸
                        if (!response.ok) {
                            throw new Error('ì„œë²„ ê²°ì œ í™•ì • ì‹¤íŒ¨');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // ì„œë²„ì—ì„œ ê²°ì œ í™•ì • ë° DB ì—…ë°ì´íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë¨
                        alert('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        window.location.href = '/BookMarket/order/orderFinished?orderId=' + rsp.merchant_uid;
                    })
                    .catch(error => {
                        // ì„œë²„ í†µì‹  ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì¸¡ ê²€ì¦ ì‹¤íŒ¨
                        alert(`ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                        // (ì„ íƒ ì‚¬í•­: ê²°ì œ ì·¨ì†Œ ë¡œì§ í˜¸ì¶œ)
                    });

                } else {
                    // ê²°ì œ ì‹¤íŒ¨ (ì‚¬ìš©ì ì·¨ì†Œ, PGì‚¬ ì˜¤ë¥˜ ë“±)
                    alert('ê²°ì œ ì‹¤íŒ¨: ' + rsp.error_msg);
                }
            });
        });
    }
});
</script>
</script>
</html>